<?php

/**
 * @file
 * Code for the PECE Access.
 */

/**
 * Implements hook_node_access().
 */
function pece_access_node_access($node, $op, $account) {
  if ($op !== 'view') {
    return NODE_ACCESS_IGNORE;
  }

  return pece_access_view_access($node, $account) ? NODE_ACCESS_ALLOW : NODE_ACCESS_DENY;
}

/**
 * Helper function for getting access to a node based on PECE specific rules.
 */
function pece_access_view_access($node, $account) {
  $artifact_node_types = array(
    'pece_artifact',
    'pece_artifact_audio',
    'pece_artifact_fieldnote',
    'pece_artifact_image',
    'pece_artifact_pdf',
    'pece_artifact_text',
    'pece_artifact_video',
    'pece_artifact_website',
  );

  if (in_array($node->type, $artifact_node_types)) {
    $node_wrapper = entity_metadata_wrapper('node', $node);
    $node_permission = $node_wrapper->field_permissions->value();
    $is_owner = ($account->uid === $node->uid);

    switch ($node_permission) {
      case 'open':
        return TRUE;

      case 'private':
        return $is_owner;

      case 'restricted':
        return ($is_owner || in_array('Researcher', $account->roles));
    }
  }

}
