<?php

/**
 * @file
 * Code for the PECE Panels.
 */

/**
 * Implements hook_module_implements_alter().
 */
function pece_panels_module_implements_alter(&$implementations, $hook) {
  if ($hook == 'form_alter' && isset($implementations['pece_panels'])) {
    $group = $implementations['pece_panels'];
    unset($implementations['pece_panels']);
    $implementations['pece_panels'] = $group;
  }
}

/**
 * Implements hook_menu_alter().
 */
function pece_panels_menu_alter(&$items) {
  if (!empty($items['node/%node/panelizer/free_panel/reset'])) {
    $items['node/%node/panelizer/free_panel/reset']['access callback'] = 'pece_panels_panelizer_free_panel_reset_access_callback';
    $items['node/%node/panelizer/free_panel/reset']['access arguments'] = array(1);
  }
}

/**
 * Access callback for resetting a node's panelizer. It should always be TRUE when
 * user has updating access to the node.
 */
function pece_panels_panelizer_free_panel_reset_access_callback($node) {
  $handler = panelizer_entity_plugin_get_handler('node');
  return $handler->entity_access('update', $node);
}

/**
 * Implements hook_panels_ipe_access().
 */
function pece_panels_panels_ipe_access($display) {
  $is_panelizer = !empty($display->context['panelizer']);
  $is_node = $is_panelizer && in_array('entity:node', $display->context['panelizer']->type);
  $is_free_panel = $is_node && $display->context['panelizer']->data->panelizer_view_mode === 'free_panel';

  // Common users should only access IPE if in a free panel panelized node page.
  return $is_free_panel;
}

/**
 * Implements hook_panelizer_access().
 */
function pece_panels_panelizer_access($op, $entity_type, $bundle, $view_mode, $entity) {
  if ($entity_type !== 'node' || empty($entity)) {
    return FALSE;
  }

  // Allow resetting to default, but prevent override.
  if ($op === 'defaults' && !empty($entity->panelizer[$view_mode]->did)) {
    return TRUE;
  }
}

/**
 * Implements hook_form_FORM_ID_alter() for panels_ipe_edit_control_form().
 *
 * Alter the IPE save control form to hide revisioning info.
 */
function pece_panels_form_panels_ipe_edit_control_form_alter(&$form, &$form_state) {
  if (!empty($form['revision_information'])) {
    $form['revision_information']['#access'] = FALSE;
  }
}
